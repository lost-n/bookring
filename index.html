<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ë‚˜ì˜ ë…ì„œ ê¸°ë¡</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  :root{
    --bg:#0f1115;--panel:#171a21;--acc:#3b82f6;--mut:#9aa3b2;--tx:#e9ecf1;--ok:#10b981;--warn:#f59e0b;--bad:#ef4444;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--tx);font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Helvetica,Arial,sans-serif;line-height:1.45}
  header{position:sticky;top:0;background:rgba(15,17,21,.8);backdrop-filter:saturate(1.2) blur(10px);z-index:5;border-bottom:1px solid #222}
  .wrap{max-width:980px;margin:0 auto;padding:20px}
  h1{font-size:22px;margin:0;padding:14px 20px}
  .grid{display:grid;gap:16px}
  @media(min-width:860px){.grid-2{grid-template-columns:1.2fr .8fr}}
  .card{background:var(--panel);border:1px solid #222;border-radius:14px;padding:16px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  label{display:block;font-size:13px;color:var(--mut);margin-bottom:6px}
  input,textarea,select,button{
    background:#0e1219;color:var(--tx);border:1px solid #2a2f3a;border-radius:10px;padding:10px 12px;font-size:14px
  }
  textarea{min-height:96px;resize:vertical}
  input[type="number"]{width:120px}
  button{cursor:pointer}
  .btn{background:#111726}
  .btn.primary{background:var(--acc);border-color:#255ad6}
  .btn.ghost{background:transparent;border-color:#2a2f3a}
  .btn.success{background:var(--ok);border-color:#0e9a6c}
  .btn.warn{background:var(--warn);border-color:#b76b00}
  .btn.danger{background:var(--bad);border-color:#b01623}
  .mut{color:var(--mut)}
  .progress{height:12px;background:#0e1219;border:1px solid #2a2f3a;border-radius:999px;overflow:hidden}
  .progress > span{display:block;height:100%;background:linear-gradient(90deg,#2563eb,#60a5fa);width:0%}
  .stat{display:flex;gap:10px;align-items:baseline}
  .stat b{font-size:22px}
  .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
  .kpi .card{padding:12px}
  .inline{display:inline-flex;gap:8px;align-items:center}
  .pill{font-size:12px;padding:4px 8px;border:1px solid #2a2f3a;border-radius:999px;color:var(--mut)}
  .calendar{width:100%}
  .cal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
  .cal-cell{border:1px solid #2a2f3a;border-radius:10px;min-height:64px;padding:6px;position:relative;background:#0e1219}
  .cal-cell .d{font-size:12px;color:var(--mut)}
  .cal-cell.read{outline:2px solid #255ad6}
  .badge{position:absolute;right:6px;bottom:6px;font-size:11px;background:#19223a;padding:2px 6px;border-radius:999px;border:1px solid #2a2f3a}
  .empty{opacity:.5}
  .list{margin:0;padding:0;list-style:none}
  .list li{padding:10px;border-bottom:1px solid #222}
  .list li:last-child{border-bottom:0}
  .right{margin-left:auto}
  .small{font-size:12px}
  .sep{height:1px;background:#222;margin:12px 0}
</style>
</head>
<body>
<header><h1>ğŸ“š ë‚˜ì˜ ë…ì„œ ê¸°ë¡</h1></header>
<div class="wrap grid grid-2">
  <!-- ì¢Œì¸¡: ì…ë ¥/íƒ€ì´ë¨¸/ì§„ë„/ì†Œê° -->
  <section class="grid">
    <div class="card">
      <h2>1) ì±… ì •ë³´ & ì§„ë„</h2>
      <div class="row">
        <div style="flex:1;min-width:220px">
          <label>ë„ì„œëª… *</label>
          <input id="title" placeholder="ì˜ˆ) ë°ë¯¸ì•ˆ" />
        </div>
        <div>
          <label>ì´ í˜ì´ì§€ *</label>
          <input id="totalPages" type="number" min="1" placeholder="ì˜ˆ) 320" />
        </div>
        <div>
          <label>í˜„ì¬ê¹Œì§€ ì½ì€ í˜ì´ì§€</label>
          <input id="currentPage" type="number" min="0" placeholder="ì˜ˆ) 85" />
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <div style="flex:1">
          <div class="progress"><span id="progressBar"></span></div>
          <div class="row" style="justify-content:space-between;margin-top:6px">
            <div class="mut small">ì§„ë„ìœ¨: <b id="progressPct">0%</b></div>
            <div class="mut small">ë‚¨ì€ í˜ì´ì§€: <b id="pagesLeft">-</b></div>
          </div>
        </div>
        <button class="btn ghost" id="saveBook">ì±… ì •ë³´ ì €ì¥</button>
      </div>
    </div>

    <div class="card">
      <h2>2) ë…ì„œ íƒ€ì´ë¨¸</h2>
      <div class="row">
        <div class="stat"><b id="timerDisplay">00:00:00</b><span class="mut">ì˜¤ëŠ˜ ëˆ„ì </span></div>
        <div class="right inline">
          <button class="btn primary" id="startBtn">ì‹œì‘</button>
          <button class="btn warn" id="pauseBtn">ì¼ì‹œì •ì§€</button>
          <button class="btn danger" id="resetBtn">ë¦¬ì…‹</button>
        </div>
      </div>
      <div class="sep"></div>
      <div class="row">
        <div>
          <label>ì´ë²ˆ ì„¸ì…˜ì— ì¶”ê°€í•œ í˜ì´ì§€</label>
          <input id="sessionPages" type="number" min="0" value="0" />
        </div>
        <button class="btn success right" id="logSession">ì„¸ì…˜ ì €ì¥</button>
      </div>
      <p class="mut small" style="margin-top:8px">ì„¸ì…˜ ì €ì¥ ì‹œ <b>ì˜¤ëŠ˜ ë‚ ì§œ</b>ë¡œ ì‹œê°„ê³¼ í˜ì´ì§€ê°€ ê¸°ë¡ë˜ê³ , ë‹¬ë ¥/í†µê³„ê°€ ê°±ì‹ ë©ë‹ˆë‹¤.</p>
    </div>

    <div class="card">
      <h2>3) ì†Œê° / ë©”ëª¨</h2>
      <label>ì˜¤ëŠ˜ì˜ í•œ ì¤„ ì†Œê°</label>
      <textarea id="note" placeholder="ì¸ìƒ ê¹Šì—ˆë˜ ë¬¸ì¥, ë– ì˜¤ë¥¸ ìƒê° ë“±ì„ ì ì–´ë³´ì„¸ìš”."></textarea>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="saveNote">ì†Œê° ì €ì¥</button>
        <span class="mut small" id="noteInfo"></span>
      </div>
      <ul class="list" id="noteList"></ul>
    </div>
  </section>

  <!-- ìš°ì¸¡: ë‹¬ë ¥/í†µê³„/ëª©í‘œ -->
  <aside class="grid">
    <div class="card">
      <h2>4) ë‹¬ë ¥(ì½ì€ ë‚  í‘œì‹œ)</h2>
      <div class="calendar">
        <div class="cal-head">
          <button class="btn ghost small" id="prevMonth">â—€</button>
          <div class="inline">
            <b id="calTitle">2025-09</b>
            <span class="pill" id="readDaysPill">ì½ì€ ë‚  0ì¼</span>
          </div>
          <button class="btn ghost small" id="nextMonth">â–¶</button>
        </div>
        <div class="cal-grid" id="calWeek">
          <div class="mut small">ì¼</div><div class="mut small">ì›”</div><div class="mut small">í™”</div>
          <div class="mut small">ìˆ˜</div><div class="mut small">ëª©</div><div class="mut small">ê¸ˆ</div><div class="mut small">í† </div>
        </div>
        <div class="cal-grid" id="calGrid"></div>
      </div>
    </div>

    <div class="card">
      <h2>5) í†µê³„</h2>
      <div class="kpi">
        <div class="card">
          <div class="mut small">ì´ë²ˆ ë‹¬ ì´ ë…ì„œ ì‹œê°„</div>
          <div class="stat"><b id="kpiTotalTime">0ë¶„</b></div>
        </div>
        <div class="card">
          <div class="mut small">ì½ì€ ë‚  ìˆ˜</div>
          <div class="stat"><b id="kpiDays">0ì¼</b></div>
        </div>
        <div class="card">
          <div class="mut small">ê°€ì¥ ë§ì´ ì½ì€ ìš”ì¼</div>
          <div class="stat"><b id="kpiBestWeekday">-</b></div>
        </div>
      </div>
      <div style="margin-top:14px">
        <canvas id="chartWeek" height="140"></canvas>
      </div>
      <div style="margin-top:14px">
        <canvas id="chartDaily" height="140"></canvas>
      </div>
    </div>

    <div class="card">
      <h2>6) ëª©í‘œ ì„¤ì •</h2>
      <div class="row">
        <div>
          <label>ì´ë²ˆ ë‹¬ ëª©í‘œ ê¶Œìˆ˜</label>
          <input id="goalBooks" type="number" min="0" value="3" />
        </div>
        <div>
          <label>í•˜ë£¨ ëª©í‘œ ì‹œê°„(ë¶„)</label>
          <input id="goalDailyMin" type="number" min="0" value="30" />
        </div>
        <button class="btn" id="saveGoals">ëª©í‘œ ì €ì¥</button>
      </div>
      <div class="sep"></div>
      <div class="row">
        <div>
          <div class="mut small">ë‹¬ì„± í˜„í™©</div>
          <div class="stat"><b id="goalBooksStatus">0 / 3 ê¶Œ</b></div>
        </div>
        <div class="right inline">
          <span class="pill" id="dailyGoalStatus">ì˜¤ëŠ˜ 0 / 30 ë¶„</span>
        </div>
      </div>
      <p class="mut small">ê¶Œìˆ˜ ë‹¬ì„±ì€ <b>ë„ì„œ ì§„ë„ìœ¨ 100%</b>ì„ ë‹¬ì„±í•œ ì±… ìˆ˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°í•©ë‹ˆë‹¤.</p>
    </div>
  </aside>
</div>

<script>
/* ========= ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ========= */
const LS = {
  book: 'rt_book',
  sessions: 'rt_sessions',
  notes: 'rt_notes',
  goals: 'rt_goals'
};

function loadLS(key, fallback){
  try{ return JSON.parse(localStorage.getItem(key)) ?? fallback; }catch{ return fallback; }
}
function saveLS(key, value){
  localStorage.setItem(key, JSON.stringify(value));
}

/* ========= ìƒíƒœ ========= */
let book = loadLS(LS.book, { title:'', totalPages:0, currentPage:0, finished:false, finishedAt:null });
let sessions = loadLS(LS.sessions, []); // {date:'YYYY-MM-DD', minutes: N, pages: N}
let notes = loadLS(LS.notes, []);       // {date:'YYYY-MM-DD HH:MM', text:'...'}
let goals = loadLS(LS.goals, { monthKey: monthKey(new Date()), goalBooks:3, goalDailyMin:30 });

/* ========= ìœ í‹¸ ========= */
function pad(n){return String(n).padStart(2,'0');}
function ymd(d){ return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate()); }
function monthKey(d){ return d.getFullYear()+'-'+pad(d.getMonth()+1); }
function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }
function minutesToText(m){
  if(m < 60) return `${m}ë¶„`;
  const h = Math.floor(m/60), mm = m%60;
  return mm? `${h}ì‹œê°„ ${mm}ë¶„` : `${h}ì‹œê°„`;
}
function weekdayName(i){ return ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][i]; }

/* ========= DOM ========= */
const $ = (s)=>document.querySelector(s);
const titleEl = $('#title'), totalPagesEl = $('#totalPages'), currentPageEl = $('#currentPage');
const progressBar = $('#progressBar'), progressPct = $('#progressPct'), pagesLeft = $('#pagesLeft');
const saveBookBtn = $('#saveBook');

const timerDisplay = $('#timerDisplay');
const startBtn = $('#startBtn'), pauseBtn = $('#pauseBtn'), resetBtn = $('#resetBtn');
const sessionPagesEl = $('#sessionPages'), logSessionBtn = $('#logSession');

const noteEl = $('#note'), saveNoteBtn = $('#saveNote'), noteInfo = $('#noteInfo'), noteList = $('#noteList');

const prevMonthBtn = $('#prevMonth'), nextMonthBtn = $('#nextMonth'), calTitle = $('#calTitle'), calGrid = $('#calGrid'), readDaysPill = $('#readDaysPill');

const kpiTotalTime = $('#kpiTotalTime'), kpiDays = $('#kpiDays'), kpiBestWeekday = $('#kpiBestWeekday');

const goalBooksEl = $('#goalBooks'), goalDailyMinEl = $('#goalDailyMin'), saveGoalsBtn = $('#saveGoals');
const goalBooksStatus = $('#goalBooksStatus'), dailyGoalStatus = $('#dailyGoalStatus');

/* ========= ì´ˆê¸° ë Œë” ========= */
function initInputs(){
  titleEl.value = book.title||'';
  totalPagesEl.value = book.totalPages||'';
  currentPageEl.value = book.currentPage||'';
  updateProgress();
  // goals month rollover
  const now = new Date();
  if(goals.monthKey !== monthKey(now)){
    goals.monthKey = monthKey(now);
    saveLS(LS.goals, goals);
  }
  goalBooksEl.value = goals.goalBooks;
  goalDailyMinEl.value = goals.goalDailyMin;
}
initInputs();

/* ========= ì§„ë„ìœ¨ ========= */
function updateProgress(){
  const total = Number(totalPagesEl.value)||0;
  const curr = Math.min(Number(currentPageEl.value)||0, total);
  let pct = 0;
  if(total>0){ pct = Math.floor((curr/total)*100); }
  progressBar.style.width = pct+'%';
  progressPct.textContent = pct+'%';
  pagesLeft.textContent = total>0 ? (total-curr) : '-';
}
['input','change'].forEach(ev=>{
  totalPagesEl.addEventListener(ev, updateProgress);
  currentPageEl.addEventListener(ev, updateProgress);
});
saveBookBtn.addEventListener('click', ()=>{
  book.title = titleEl.value.trim();
  book.totalPages = Number(totalPagesEl.value)||0;
  book.currentPage = clamp(Number(currentPageEl.value)||0, 0, book.totalPages);
  // ì™„ë£Œ ì²´í¬
  if(book.totalPages>0 && book.currentPage>=book.totalPages){
    book.finished = true; 
    book.finishedAt = book.finishedAt || new Date().toISOString();
  } else {
    book.finished = false; 
    book.finishedAt = null;
  }
  saveLS(LS.book, book);
  updateProgress();
  alert('ì±… ì •ë³´ë¥¼ ì €ì¥í–ˆìŠµë‹ˆë‹¤.');
});

/* ========= íƒ€ì´ë¨¸ ========= */
let ticking = false, startTs = null, todayAccMin = getTodayMinutes();
function getTodayMinutes(){
  const today = ymd(new Date());
  return sessions.filter(s=>s.date===today).reduce((a,b)=>a+b.minutes,0);
}
function renderTimer(){
  const totalSec = todayAccMin*60 + (ticking ? Math.floor((Date.now()-startTs)/1000) : 0);
  const h = Math.floor(totalSec/3600), m = Math.floor((totalSec%3600)/60), s = totalSec%60;
  timerDisplay.textContent = `${pad(h)}:${pad(m)}:${pad(s)}`;
  // ì˜¤ëŠ˜ ëª©í‘œ í‘œì‹œ
  dailyGoalStatus.textContent = `ì˜¤ëŠ˜ ${Math.floor(totalSec/60)} / ${goals.goalDailyMin} ë¶„`;
  dailyGoalStatus.style.borderColor = (totalSec/60)>=goals.goalDailyMin ? '#0e9a6c' : '#2a2f3a';
  dailyGoalStatus.style.color = (totalSec/60)>=goals.goalDailyMin ? '#a7f3d0' : 'var(--mut)';
}
let rafId;
function loop(){ renderTimer(); rafId = requestAnimationFrame(loop); }
loop();

startBtn.addEventListener('click', ()=>{
  if(!ticking){ ticking=true; startTs=Date.now(); }
});
pauseBtn.addEventListener('click', ()=>{
  if(ticking){
    const addMin = Math.max(0, Math.round((Date.now()-startTs)/60000));
    todayAccMin += addMin;
    ticking=false; startTs=null;
  }
});
resetBtn.addEventListener('click', ()=>{
  if(confirm('ì˜¤ëŠ˜ íƒ€ì´ë¨¸ ëˆ„ì ì„ 0ìœ¼ë¡œ ì´ˆê¸°í™”í• ê¹Œìš”?')){
    ticking=false; startTs=null; todayAccMin=0; renderTimer();
  }
});

/* ========= ì„¸ì…˜ ì €ì¥ ========= */
logSessionBtn.addEventListener('click', ()=>{
  if(!book.title){ return alert('ë„ì„œëª…ì„ ë¨¼ì € ì…ë ¥/ì €ì¥í•´ì£¼ì„¸ìš”.'); }
  // íƒ€ì´ë¨¸ë„ ë©ˆì¶”ê³  ëˆ„ì  ë°˜ì˜
  if(ticking){
    const addMin = Math.max(0, Math.round((Date.now()-startTs)/60000));
    todayAccMin += addMin; ticking=false; startTs=null;
  }
  const mins = todayAccMin;
  const addPages = Number(sessionPagesEl.value)||0;
  if(mins<=0 && addPages<=0){ return alert('ê¸°ë¡í•  ì‹œê°„ì´ ì—†ê±°ë‚˜ í˜ì´ì§€ ì¶”ê°€ê°€ 0ì…ë‹ˆë‹¤.'); }

  const today = ymd(new Date());
  sessions.push({date:today, minutes:mins, pages:addPages});
  saveLS(LS.sessions, sessions);

  // ì±… ì§„ë„ ë°˜ì˜
  if(addPages>0){
    book.currentPage = clamp((book.currentPage||0)+addPages, 0, book.totalPages||999999);
    if(book.totalPages>0 && book.currentPage>=book.totalPages){
      book.finished = true; book.finishedAt = book.finishedAt || new Date().toISOString();
    }
    currentPageEl.value = book.currentPage;
    saveLS(LS.book, book);
    updateProgress();
  }

  todayAccMin = 0;
  sessionPagesEl.value = 0;

  alert('ì„¸ì…˜ì„ ì €ì¥í–ˆì–´ìš”!');
  renderAllAnalytics();
});

/* ========= ì†Œê° ========= */
function renderNotes(){
  noteList.innerHTML = '';
  if(notes.length===0){
    const li = document.createElement('li');
    li.className='mut'; li.textContent='ì•„ì§ ì†Œê°ì´ ì—†ìŠµë‹ˆë‹¤.';
    noteList.appendChild(li);
    return;
  }
  [...notes].reverse().slice(0,10).forEach(n=>{
    const li = document.createElement('li');
    li.innerHTML = `<div class="small mut">${n.date}</div><div>${escapeHtml(n.text)}</div>`;
    noteList.appendChild(li);
  });
}
function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

saveNoteBtn.addEventListener('click', ()=>{
  const t = noteEl.value.trim();
  if(!t) return alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
  const now = new Date();
  const ts = `${ymd(now)} ${pad(now.getHours())}:${pad(now.getMinutes())}`;
  notes.push({date:ts, text:t});
  saveLS(LS.notes, notes);
  noteEl.value = '';
  noteInfo.textContent = 'ì €ì¥ë¨';
  setTimeout(()=>noteInfo.textContent='', 1500);
  renderNotes();
});

/* ========= ë‹¬ë ¥ ========= */
let calRef = new Date(); // í˜„ì¬ í‘œì‹œ ì›”
function buildCalendar(){
  const year = calRef.getFullYear(), month = calRef.getMonth(); // 0~11
  calTitle.textContent = `${year}-${pad(month+1)}`;

  // ì´ ë‹¬ì˜ ì„¸ì…˜ ë§µ
  const map = new Map(); // dateStr -> minutes
  sessions.forEach(s=>{
    const d = new Date(s.date+'T00:00:00');
    if(d.getFullYear()===year && d.getMonth()===month){
      map.set(s.date, (map.get(s.date)||0) + s.minutes);
    }
  });

  // 1ì¼ì˜ ìš”ì¼
  const first = new Date(year, month, 1);
  const last = new Date(year, month+1, 0).getDate();
  const lead = first.getDay(); // 0=ì¼
  const cells = [];

  // ì• ë¹ˆì¹¸
  for(let i=0;i<lead;i++){ cells.push({empty:true}); }
  // ë‚ ì§œ
  for(let d=1; d<=last; d++){
    const ds = `${year}-${pad(month+1)}-${pad(d)}`;
    const mins = map.get(ds)||0;
    cells.push({day:d, minutes:mins});
  }
  // ë’· ë¹ˆì¹¸(ì´ 6ì£¼ ê·¸ë¦¬ë“œ ë§ì¶¤)
  while(cells.length%7!==0) cells.push({empty:true});

  calGrid.innerHTML = '';
  let readDays = 0;
  cells.forEach(c=>{
    const div = document.createElement('div');
    div.className = 'cal-cell' + (c.empty? ' empty':'' ) + ((c.minutes>0 && !c.empty)? ' read':'' );
    if(!c.empty){
      if(c.minutes>0) readDays++;
      div.innerHTML = `<div class="d">${c.day}</div>` + (c.minutes>0? `<div class="badge">${minutesToText(c.minutes)}</div>`:'');
    }
    calGrid.appendChild(div);
  });
  readDaysPill.textContent = `ì½ì€ ë‚  ${readDays}ì¼`;
}
prevMonthBtn.addEventListener('click', ()=>{ calRef.setMonth(calRef.getMonth()-1); buildCalendar(); });
nextMonthBtn.addEventListener('click', ()=>{ calRef.setMonth(calRef.getMonth()+1); buildCalendar(); });

/* ========= í†µê³„ ========= */
let chartWeek, chartDaily;

function getMonthSessions(dRef){
  const y = dRef.getFullYear(), m = dRef.getMonth();
  return sessions.filter(s=>{
    const d = new Date(s.date+'T00:00:00');
    return d.getFullYear()===y && d.getMonth()===m;
  });
}
function computeMonthStats(dRef){
  const arr = getMonthSessions(dRef);
  const totalMin = arr.reduce((a,b)=>a+b.minutes,0);
  const daySet = new Set(arr.map(s=>s.date));
  const perWeekday = [0,0,0,0,0,0,0];
  arr.forEach(s=>{
    const d = new Date(s.date+'T00:00:00');
    perWeekday[d.getDay()] += s.minutes;
  });
  const bestIdx = perWeekday.reduce((bi,cur,i,ar)=> cur>ar[bi]? i:bi, 0);
  return { totalMin, readDays: daySet.size, perWeekday };
}
function buildCharts(){
  const ctxW = document.getElementById('chartWeek');
  const ctxD = document.getElementById('chartDaily');

  const lblW = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
  const perW = computeMonthStats(calRef).perWeekday;

  chartWeek && chartWeek.destroy();
  chartWeek = new Chart(ctxW, {
    type:'bar',
    data:{ labels: lblW, datasets:[{ label:'ìš”ì¼ë³„ ë…ì„œ(ë¶„)', data: perW }] },
    options:{ responsive:true, plugins:{ legend:{display:false} } }
  });

  // ì¼ìë³„
  const y = calRef.getFullYear(), m = calRef.getMonth();
  const last = new Date(y, m+1, 0).getDate();
  const byDay = Array.from({length:last}, (_,i)=>0);
  getMonthSessions(calRef).forEach(s=>{
    const d = new Date(s.date+'T00:00:00').getDate();
    byDay[d-1] += s.minutes;
  });
  chartDaily && chartDaily.destroy();
  chartDaily = new Chart(ctxD, {
    type:'line',
    data:{ labels: byDay.map((_,i)=>String(i+1)), datasets:[{ label:'ì¼ìë³„ ë…ì„œ(ë¶„)', data: byDay, fill:false, tension:.25 }] },
    options:{ responsive:true, plugins:{ legend:{display:false} } }
  });
}

function renderKPIs(){
  const st = computeMonthStats(calRef);
  kpiTotalTime.textContent = minutesToText(st.totalMin);
  kpiDays.textContent = `${st.readDays}ì¼`;
  kpiBestWeekday.textContent = st.perWeekday.every(v=>v===0)? '-' : weekdayName(st.perWeekday.indexOf(Math.max(...st.perWeekday)));
}

/* ========= ëª©í‘œ ========= */
function countFinishedBooksThisMonth(){
  if(!book.finished || !book.finishedAt) return 0;
  const d = new Date(book.finishedAt);
  return (monthKey(d)===monthKey(calRef)) ? 1 : 0;
}
function renderGoals(){
  const finished = countFinishedBooksThisMonth();
  goalBooksStatus.textContent = `${finished} / ${goals.goalBooks} ê¶Œ`;
  goalBooksStatus.style.color = finished>=goals.goalBooks ? '#a7f3d0' : 'var(--tx)';
}
saveGoalsBtn.addEventListener('click', ()=>{
  goals.goalBooks = Math.max(0, Number(goalBooksEl.value)||0);
  goals.goalDailyMin = Math.max(0, Number(goalDailyMinEl.value)||0);
  goals.monthKey = monthKey(new Date());
  saveLS(LS.goals, goals);
  renderGoals();
  renderTimer();
  alert('ëª©í‘œë¥¼ ì €ì¥í–ˆì–´ìš”!');
});

/* ========= ì¢…í•© ë Œë” ========= */
function renderAllAnalytics(){
  buildCalendar();
  buildCharts();
  renderKPIs();
  renderGoals();
  renderNotes();
}
renderAllAnalytics();

/* ========= ì´ˆê¸° í˜ì´ì§€ ë¡œë“œì‹œ ê²½ê³ (í•„ìˆ˜ ì…ë ¥) ========= */
window.addEventListener('load', ()=>{
  if(!book.title || !book.totalPages){
    // ì•ˆë‚´ë§Œ (ì°¨ë‹¨X)
    console.info('ë„ì„œëª…ê³¼ ì´ í˜ì´ì§€ë¥¼ ì…ë ¥/ì €ì¥í•˜ë©´ ì§„ë„ìœ¨ê³¼ ëª©í‘œ ë‹¬ì„±ì´ ì •í™•í•´ì ¸ìš”.');
  }
});
</script>
</body>
</html>
